<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Transaction lifecycle - The Dango Book</title>


        <!-- Custom HTML head -->

        <meta name="description" content="Everything about Dango">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Dango Book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/left-curve/left-curve" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="transaction-lifecycle"><a class="header" href="#transaction-lifecycle">Transaction lifecycle</a></h1>
<p>A Grug transaction (tx) is defined by the following struct:</p>
<pre><pre class="playground"><code class="language-rust edition2021"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>struct Tx {
    pub sender: Addr,
    pub gas_limit: u64,
    pub msgs: Vec&lt;Message&gt;,
    pub data: Json,
    pub credential: Json,
}
<span class="boring">}</span></code></pre></pre>
<p>Explanation of the fields:</p>
<h4 id="sender"><a class="header" href="#sender">Sender</a></h4>
<p>The account that sends this tx, who will perform authentication and (usually) pay the tx fee.</p>
<h4 id="gas-limit"><a class="header" href="#gas-limit">Gas limit</a></h4>
<p>The maximum amount of gas requested for executing this tx.</p>
<p>If gas of this amount is exhausted at any point, execution is aborted and state changes discarded.<sup class="footnote-reference" id="fr-1-1"><a href="#footnote-1">1</a></sup></p>
<h4 id="messages"><a class="header" href="#messages">Messages</a></h4>
<p>A list of <code>Message</code>s to be executed.</p>
<p>They are executed in the specified order and <em>atomically</em>, meaning they either succeed altogether, or fail altogether; a single failed message failing leads to the entire tx aborted.<sup class="footnote-reference" id="fr-2-1"><a href="#footnote-2">2</a></sup></p>
<h4 id="data"><a class="header" href="#data">Data</a></h4>
<p>Auxilliary data to attach to the tx.</p>
<p>An example use case of this is if the chain accepts multiple tokens for fee payment, the sender can specify here which denom to use:</p>
<pre><code class="language-json">{
  "data": {
    "fee_denom": "uatom"
  }
}
</code></pre>
<p>The <strong>taxman</strong> contract, which handles fees, should be programmed to deserialize this data, and use appropriate logics to handle the fee (e.g. swap the tokens on a DEX).</p>
<h4 id="credential"><a class="header" href="#credential">Credential</a></h4>
<p>An arbitrary data to prove the tx was composed by the rightful owner of the sender account. Most commonly, this is a cryptographic signature.</p>
<p>Note that <code>data</code> is an opaque <code>grug::Json</code> (which is an alias to <code>serde_json::Value</code>) instead of a concrete type. This is because Grug does not attempt to intrepret or do anything about the credential. It's all up to the sender account. Different accounts may expect different credential types.</p>
<p>Next we discuss the full lifecycle of a transaction.</p>
<h2 id="simulation"><a class="header" href="#simulation">Simulation</a></h2>
<p>The user have specified <code>sender</code>, <code>msgs</code>, and <code>data</code> fields by interacting with a webapp. The next step now is to determine an appropriate <code>gas_limit</code>.</p>
<p>For some simple txs, we can make a reasonably good guess of gas consumption. For example, a tx consisting of a single <code>Message::Transfer</code> of a single coin should consume just under 1,000,000 gas (of which 770,000 is for Secp256k1 signature verification).</p>
<p>However, for more complex txs, it's necessary to query a node to <strong>simulate</strong> its gas consumption.</p>
<p>To do this, compose an <code>UnsignedTx</code> value:</p>
<pre><pre class="playground"><code class="language-rust edition2021"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>struct UnsignedTx {
    pub sender: Addr,
    pub msgs: Vec&lt;Message&gt;,
    pub data: Json,
}
<span class="boring">}</span></code></pre></pre>
<p>which is basically <code>Tx</code> but lacks the <code>gas_limit</code> and <code>credential</code> fields.</p>
<p>Then, invoke the ABCI <code>Query</code> method with the string <code>"/simulate"</code> as <code>path</code>:</p>
<ul>
<li>Using the Rust SDK, this can be done with the <code>grug_sdk::Client::simulate</code> method.</li>
<li>Using the CLI, append the <code>--simulate</code> to the <code>tx</code> subcommand.</li>
</ul>
<p>The <code>App</code> will run <em>the entire tx</em> in <strong>simulation mode</strong>, and return an <code>Outcome</code> value:</p>
<pre><pre class="playground"><code class="language-rust edition2021"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>struct Outcome {
    pub gas_limit: Option&lt;u64&gt;,
    pub gas_used: u64,
    pub result: GenericResult&lt;Vec&lt;Event&gt;&gt;,
}
<span class="boring">}</span></code></pre></pre>
<p>This includes the amount of gas used, and if the tx succeeded, the events that were emitted; or, in case the tx failed, the error message.</p>
<p>Two things to note:</p>
<ul>
<li>In simulation mode, certain steps in authentication are skipped, such as signature verification (we haven't signed the tx yet at this point). This means gas consumption is underestimated. Since we know an Secp256k1 verification costs 770,000 gas, it's advisable to add this amount manually.</li>
<li>The max amount of gas the simulation can consume is the node's query gas limit, which is an offchain parameter chosen individually by each node. If the node has a low query gas limit (e.g. if the node is not intended to serve heavy query requests), the simulation may fail.</li>
</ul>
<h2 id="checktx"><a class="header" href="#checktx">CheckTx</a></h2>
<p>Now we know the gas limit, the user will sign the tx, and we create the <code>Tx</code> value and broadcast it to a node.</p>
<p>Tendermint will now call the ABCI <code>CheckTx</code> method, and decide whether to accept the tx into mempool or not, based on the result.</p>
<p>When serving a <code>CheckTx</code> request, the <code>App</code> doesn't execute the entire tx. This is because while some messages may fail at this time, they may succeed during <code>FinalizeBlock</code>, as the chain's state would have changed.</p>
<p>Therefore, instead, the <code>App</code> only performs the first two steps:</p>
<ol>
<li>Call the taxman's <code>withhold_fee</code> method. This ensures the tx's sender has enough fund to afford the tx fee.</li>
<li>Call the sender's <code>authenticate</code> method in normal (i.e. non-simulation) mode. Here the sender performs authentication (which is skipped in simulation mode).</li>
</ol>
<p>Tendermint will reject the tx if <code>CheckTx</code> fails (meaning, either <code>withfold_fee</code> or <code>authenticate</code> fails), or if the tx's gas limit is bigger than the block gas limit (it can't fit in a block). Otherwise, it's inserted into the mempool.</p>
<h2 id="finalizeblock"><a class="header" href="#finalizeblock">FinalizeBlock</a></h2>
<p>In <code>FinalizeBlock</code>, the entire tx processing flow is performed, which is:</p>
<ol>
<li>
<p>Call taxman's <code>withhold_fee</code> method.</p>
<p>This MUST succeed (if it would fail, it should have failed during <code>CheckTx</code> such that the tx is rejected from entering mempool). If does fail for some reason (e.g. a previous tx in the block drained the sender's wallet, so it can no longer affored the fee), the processing is aborted and all state changes discarded.</p>
</li>
<li>
<p>Call sender's <code>authenticate</code> method.</p>
<p>If fails, discard state changes from step 2 (keeping those from step 1), then jump to step 5.</p>
</li>
<li>
<p>Loop through the messages, execute one by one.</p>
<p>If any fails, discard state changes from step 2-3, then jump to step 5.</p>
</li>
<li>
<p>Call sender's <code>backrun</code> method.</p>
<p>If fails, discard state changes from step 2-4, then jump to step 5.</p>
</li>
<li>
<p>Call taxman's <code>finalize_fee</code> method.</p>
<p>This MUST succeed (the bank and taxman contracts should be programmed in a way that ensures this). If it does fail for some reason, discard all state changes for all previous steps and abort.</p>
</li>
</ol>
<blockquote>
<p>TODO: make a flow chart</p>
</blockquote>
<h2 id="summary"><a class="header" href="#summary">Summary</a></h2>
<div class="table-wrapper"><table><thead><tr><th></th><th>Simulate</th><th>CheckTx</th><th>FinalizeBlock</th></tr></thead><tbody>
<tr><td>Input type</td><td><code>UnsignedTx</code></td><td><code>Tx</code></td><td><code>Tx</code></td></tr>
<tr><td>Call taxman <code>withhold_fee</code></td><td>Yes</td><td>Yes</td><td>Yes</td></tr>
<tr><td>Call sender <code>authenticate</code></td><td>Yes, in simulation mode</td><td>Yes, in normal mode</td><td>Yes, in normal mode</td></tr>
<tr><td>Execute messages</td><td>Yes</td><td>No</td><td>Yes</td></tr>
<tr><td>Call sender <code>backrun</code></td><td>Yes</td><td>No</td><td>Yes</td></tr>
<tr><td>Call taxman <code>finalize_fee</code></td><td>Yes</td><td>No</td><td>Yes</td></tr>
</tbody></table>
</div><hr>
<ol class="footnote-definition"><li id="footnote-1">
<p>Transaction fee is still deducted. See the discussion on fee handling later in the article. <a href="#fr-1-1">↩</a></p>
</li>
<li id="footnote-2">
<p>This said, a <code>SubMessage</code> can fail without aborting the tx, if it's configured as such (with <code>SubMessage::reply_on</code> set to <code>ReplyOn::Always</code> or <code>ReplyOn::Error</code>). <a href="#fr-2-1">↩</a></p>
</li>
</ol>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../notes/nonces.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../networks/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../notes/nonces.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../networks/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
