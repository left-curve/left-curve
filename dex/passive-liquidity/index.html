<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Passive liquidity - The Dango Book</title>


        <!-- Custom HTML head -->

        <meta name="description" content="Everything about Dango">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Dango Book</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/left-curve/left-curve" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="passive-liquidity-on-dango-dex"><a class="header" href="#passive-liquidity-on-dango-dex">Passive liquidity on Dango DEX</a></h1>
<p>Dango DEX is a fully onchain limit order book (LOB) exchange. It uses <a href="https://academic.oup.com/qje/article/130/4/1547/1916146">frequent batch auctions (FBAs)</a>, executed at the end of each block, to match orders. Otherwise, it's not dissimilar to other LOB exchanges, e.g. Hyperliquid.</p>
<p>A major downside of LOBs vs AMMs is that <strong>market making on LOBs requires a high level of sophistication, making it infeasible to average retail investors</strong>. As such, new LOB exchanges often need to enter into deals with professional market makers (MMs) to provide liquidity. This makes bootstrapping a new LOB exchange very challenging.</p>
<p>From the perspective of an unsophisticated investor who wishes to provide liquidity <em>complete passively</em> on major spot pairs (BTC-USD, ETH-USD, etc.), as of this time, their only options are Uniswap V3 (full range) and Curve V2. However, LP'ing on these AMMs have proven to be generally not profitable due to arbitrage trades.</p>
<p>Loss from arbitrage trades, measured by <a href="https://arxiv.org/abs/2208.06046">loss-versus-rebalancing (LVR)</a>, occurs when there's another, more liquid venue for trading the same pair, where price discovery primarily takes place. In crypto, this is typically the CEXs: Binance, Coinbase, Kraken, etc. Suppose BTC-USD is trading at 95,000. Then, upon a favorable news, it jumps to 96,000 on Binance. However, AMMs are completely passive--they never actively adjust quotes based on the news. As such, an arbitrageur can buy BTC at the stale price of 95,000 from the AMM, then sell on Binance for 96,000. LPs in the AMM takes the worse side of the trade. Over time, such losses accumulate and more often than not, outpace the gains from fees.</p>
<h2 id="the-objective"><a class="header" href="#the-objective">The objective</a></h2>
<p>Create a passive liquidity pool that provides liquidity on Dango DEX, with the following properties:</p>
<ul>
<li>It will <strong>place limit orders in the LOB following a predefined strategy, such as an oracle-informed AMM curve</strong>.</li>
<li>It aims to be the <strong>backstop liquidity</strong>. Meaning, it doesn't need to quote aggressively with super tight spreads. We anticipate professional MMs will take that role. The pool will quote wider (thus taking less risk), and be the backstop in case a big trade eats up all the orders from MMs.</li>
<li>It targets majors (BTC, ETH, SOL, etc.) and should be <strong>LVR-resistant</strong>. At Dango, we want to maximize the benefit of LPs by discouraging arbitrage flow.</li>
<li>It <strong>doesn't aim to be resistant to impermanent loss (IL)</strong>. However, once we ship perpetual futures trading on Dango, we imagine there will be actively managed "vaults" that combine the LP pool and hedging strategies using perps.</li>
</ul>
<h2 id="order-placement"><a class="header" href="#order-placement">Order placement</a></h2>
<p>Let's discuss how the pool may determine what orders to place in the LOB. Let's think of the simplest strategy: the constant product curve ("xyk curve").</p>
<p>Consider a BTC-USD pool that currently contains $x$ units of BTC (the "base asset") and $y$ units of USD (the "quote asset"). The state of the pool can be considered a point on the curve $I(x, y) = x y = K$, where $K$ is a constant that quantifies how much liquidity there is in the pool. When a trade happens, the state moves to a different point on the same curve (that is, without considering any fee).</p>
<p>Generally, for any AMM curve $I(x, y)$, we define the concept of <strong>marginal price</strong> as:</p>
<p>$$
p_{\mathrm{m}} (x, y) = - \frac{\mathrm{d}y}{\mathrm{d}x} = \frac{\frac{\partial I}{\partial{x}}}{\frac{\partial I}{\partial y}}
$$</p>
<p>For the xyk curve, this is:</p>
<p>$$
p_{\mathrm{m}} (x, y) = \frac{y}{x}
$$</p>
<p>$p_{\mathrm{m}}$ is the price, denoted as the units of quote asset per one unit of base asset (that is, $y$ over $x$), of trading an infinitesimal amount of one asset to the other. On a graph, it is the slope of the tangent line that touches the curve at the point $(x, y)$.</p>
<p><img src="./1.png" alt="1" /></p>
<p>Let's imagine the pool starts from the state of $(x_0 = 5, y_0 = 2)$; marginal price $p_{\mathrm{m}} (x_0, y_0) = 0.4$ USD per BTC.</p>
<p>At this time, if a trader swaps 2 units of USD to 2.5 units of BTC, the state would move to the point $(x_1 = 2.5, y_1 = 4)$, marginal price $p_{\mathrm{m}} (x_1, y_1) = 1.6$ USD per BTC.</p>
<p>We interpret this as follows: <strong>under the state of $(x = 5, y = 2)$ and following the strategy defined by the xyk curve, the pool offers to sell 2.5 units of BTC over the price range of 0.4--1.6 USD per BTC</strong>.</p>
<p>Translating this to the context of orderbook, this means <strong>the pool would place SELL orders of sizes totalling 2.5 units of BTC between the prices 0.4 and 1.6</strong>.</p>
<p>Following this logic, we can devise the following algorithm to work out all the SELL orders that the pool would place:</p>
<ul>
<li>The pool is parameterized by spread $p_{\mathrm{s}}$ and "bin size" $\Delta p$.</li>
<li>Start from the marginal price $p_{\mathrm{m}} (x_0, y_0)$ (we denote this simply as $p_{\mathrm{m}}$ from here on).
<ul>
<li>The pool would not place any order here. We say the total order size here is zero.</li>
</ul>
</li>
<li>Move on to the "bin" at price $p_0 = p_{\mathrm{m}} + \frac{1}{2} p_{\mathrm{s}}$ (marginal price plus the half spread).
<ul>
<li>This is the price at which the pool will place its first SELL order.</li>
<li>Using the approach discussed above, find the total order size between the prices $p_0$ and $p_{\mathrm{m}}$. This is the size of the order to be place here.</li>
</ul>
</li>
<li>Move on to the next "bin", at price $p_1 = p + \Delta p$.
<ul>
<li>Using the approach discussed above, find the total order size between the prices $p_1$ and $p_0$.</li>
<li>Subtract the total order size between $p_{\mathrm{m}}$ and $p_0$, this is the order size to be placed here.</li>
</ul>
</li>
<li>Do the same for $p_2$, $p_3$, ... until liquidity runs out (total order size $\ge x_0$).</li>
</ul>
<p>With the same approach, we can work out all the BUY orders for prices below $p_{\mathrm{m}}$.</p>
<p>For the xyk curve, the orders are visualized as follows (based on the state $x_0 = 1$, $y_0 = 200$ and parameters $p_{\mathrm{s}} = 0.2$, $\Delta p = 0.1$):</p>
<p><img src="../../papers/dango-dex/1-xyk.png" alt="xyk" /></p>
<p>We see the pool places orders of roughtly the same size across a wide price range. That is, the liquidity isn't concentrated.</p>
<p>As example for a concentrated liquidity curve, the Solidly curve $I(x, y) = x^3 y + x y^3$ results in the following orders:</p>
<p><img src="../../papers/dango-dex/2-solidly.png" alt="solidly" /></p>
<p>As we see, liquidity is significantly more concentrated here.</p>
<h2 id="tackling-arbitrage-loss"><a class="header" href="#tackling-arbitrage-loss">Tackling arbitrage loss</a></h2>
<p>In order to discourage arbitrage flow, <strong>the pool needs to actively adjusts its quote based on the prices trading at other more liquid venues</strong> (the CEXs, in our case).</p>
<p>To achieve this, we simply introduce an oracle price term into the AMM invariant. Suppose the oracle price is $p$. Instead of $I(x, y)$, we simply use the curve:</p>
<p>$$
I_{\mathrm{oracle}}(x, y, p) = I \left( x, \frac{y}{p} \right)
$$</p>
<p>The xyk and Solidly curves become the following, respectively:</p>
<p>$$
I_{\mathrm{oracle}}(x, y, p) = x \left( \frac{y}{p} \right)
$$</p>
<p>$$
I_{\mathrm{oracle}}(x, y, p) = x^3 \left( \frac{y}{p} \right) + x \left( \frac{y}{p} \right)^3
$$</p>
<p>Following the same example with Solidly above, but set oracle price to $p = 210$ (higher than the margin price of 200), the orders become:</p>
<p><img src="../../papers/dango-dex/3-solidly-price-jump.png" alt="solidly-price-jump" /></p>
<p>As we see, the pool now quotes around the price of 210. It places bigger orders on the SELL side than the BUY side, demonstrating that it has a tendency to reduce its holding of the base asset, so that its inventory goes closer the ratio of 1:210 as the oracle indicates.</p>
<h2 id="oracle-risk"><a class="header" href="#oracle-risk">Oracle risk</a></h2>
<p>The biggest risk of an oracle-informed AMM is that the oracle reports incorrect prices. For example, if BTC is trading at 95,000, but the oracle says the price is 0.0001, then traders are able to buy BTC from Dango at around 0.0001, resulting in almost total loss for our LPs.</p>
<p>To reduce the chance of this happening, we plan to employ the following:</p>
<ul>
<li>Use a low latency oracle, specifically <a href="https://www.pyth.network/">Pyth's 10 ms or 50 ms feed</a>.</li>
<li>Pyth prices come with a confidence range, meaning a range it thinks there's a 95% probability the true price is in. Our parameter $p_{\mathrm{s}}$ should be configured to be similar or larger than this.</li>
<li>Make the oracle a part of our block building logic. A block is invalid if it doesn't contain an oracle price. The block producer must submit the price in a transaction on the top of the block.</li>
<li>The LP pool is given priority to adjust its orders in response to the oracle price before anyone else. Specifically, since we use FBA, the LP pool is allowed to adjust its orders prior to the auction.</li>
<li>Implement circuit breakers, that if triggered, the LP pool would cancel all its orders and do nothing, until the situation goes back to normal. These can include:
<ul>
<li>Oracle price is too old (older than a given threshold).</li>
<li>Oracle price makes too big of a jump (e.g. it goes from 95,000 to 0.0001).</li>
</ul>
</li>
</ul>
<h2 id="open-questions"><a class="header" href="#open-questions">Open questions</a></h2>
<ul>
<li>A Professional market maker usually doesn't place orders around the oracle price, but rather computes a "reservation price" based on the oracle price as well as his current inventory. Additionally, he usually doesn't use equal spread on both sides, but rather skewed spreads based on inventory. A classic model for computing these is that by <a href="https://www.tandfonline.com/doi/abs/10.1080/14697680701381228">Avellaneda and Stoikov</a>. Our model do not do these.</li>
<li>Whereas Solidly is the simplest concentrated liquidity curve (simpler than Curve V1 or V2), it's still quite computationally heavy. We need to solve a quartic (4th degree polynomial) equation using Newton's method, for each "bin", each block. We would like to explore simpler concentrated liquidity curves.</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../audits/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../audits/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
