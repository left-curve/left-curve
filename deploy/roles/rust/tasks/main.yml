- name: Ensure dependencies are installed
  apt:
    name:
      - curl
      - build-essential
      - libssl-dev
      - clang
      - pkg-config
    state: present
    update_cache: yes

- name: Install rustup
  become: true
  become_user: "{{ runner_user }}"
  shell: |
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
  args:
    executable: /bin/bash

- name: Install Rust components
  become: true
  become_user: "{{ runner_user }}"
  shell: |
    source /etc/profile
    rustup component add clippy rustfmt rust-src
    rustup component add rustfmt clippy rust-src --toolchain nightly
  environment:
    CARGO_HOME: /home/{{ runner_user }}/.cargo
    RUSTUP_HOME: /home/{{ runner_user }}/.rustup
    PATH: /home/{{ runner_user }}/.cargo/bin:{{ ansible_env.PATH }}
  args:
    executable: /bin/bash
