# Find a way to change password for root/debian but store that securely
# - name: Change password for the Ansible‚Äêconnected user
#   user:
#     name: "{{ ansible_user_id }}"
#     password: "{{ ansible_user_password | password_hash('sha512') }}"
#     update_password: always
#   when: ansible_user_password != ''

- name: Install locales package
  apt:
    name: locales
    state: present
    update_cache: yes

- name: Set default system locale
  lineinfile:
    path: /etc/locale.gen
    regexp: 'en_US.UTF-8 UTF-8'
    line: 'en_US.UTF-8 UTF-8'

- name: Generate en_US.UTF-8 locale
  command: locale-gen en_US.UTF-8

- name: Set default system locale
  lineinfile:
    path: /etc/default/locale
    regexp: '^LANG='
    line: 'LANG=en_US.UTF-8'
    create: yes

- name: Reconfigure locales
  command: dpkg-reconfigure --frontend=noninteractive locales

- name: Write /etc/hostname
  become: yes
  ansible.builtin.copy:
    dest: /etc/hostname
    content: "{{ hostname }}\n"
    mode: "0644"

- name: Apply hostname immediately (no D-Bus)
  become: yes
  ansible.builtin.command: hostname -F /etc/hostname
  changed_when: false

- name: Update /etc/hosts
  lineinfile:
    path: /etc/hosts
    regexp: '^127\.0\.1\.1'
    line: "127.0.1.1 {{ hostname }}"

- name: Install base packages
  apt:
    name:
      - iperf3
      - rsyslog
      - ufw
      - curl
      - git
      - ca-certificates
      - fail2ban
      - tmux
      - mosh
      - sudo
      - gnupg
      - apt-transport-https
      - vim
      - btop
      - htop
      - jq
      - libyaml-dev
      - build-essential
      - libssl-dev
      - clang
      - pkg-config
      - direnv
      - python3-boto3
      - python3-botocore
      - python3-psycopg2
      - python3-clickhouse-driver
      - pipx
    state: present
    update_cache: yes

- name: Refresh network facts
  setup:
    gather_subset:
      - network
- ufw: state=reset
  tags: setup
- ufw: default=allow direction=outgoing
  tags: setup
- ufw: default=deny direction=incoming
  tags: setup
- name: Allow SSH on non-tailscale
  ufw:
    rule: allow
    direction: in
    port: "{{ item }}"
    proto: tcp
  loop:
    - ssh
    # mosh
    - '60000:61000'
- name: Allow any port on tailscale0
  ufw:
    rule: allow
    direction: in
    interface: tailscale0
- ufw:
    rule: allow
    direction: in
    port: "{{ item }}"
    proto: udp
  # Tailscale
  with_items: ['41641']
- ufw: logging=low
  tags: setup
- ufw: state=enabled
  tags: setup

- copy:
    src: "jail.local"
    dest: /etc/fail2ban/
    mode: '0644'

- name: Whitelist Tailscale IP range in fail2ban (sshd)
  become: true
  lineinfile:
    path: /etc/fail2ban/jail.local
    insertafter: '^\[sshd\]'
    regexp: '^ignoreip\s*='
    line: 'ignoreip = 127.0.0.1/8 ::1 100.64.0.0/10 10.99.0.0/28'

- name: Restart fail2ban
  service:
    name: fail2ban
    state: restarted

- file:
    state: absent
    path: /etc/motd

- copy:
    src: "{{ item }}"
    dest: /etc/update-motd.d/
    mode: '0755'
  with_items:
    - 10-banner
    - 20-sysinfo

- name: Raise kernel fd ceilings
  ansible.posix.sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    state: present
    sysctl_set: yes
    reload: yes
  loop:
    # File descriptor limits
    - { name: "fs.nr_open",                value: "1048576" }
    - { name: "fs.file-max",               value: "1048576" }

    # Connection backlog tuning
    - { name: "net.core.somaxconn",        value: "65535" }
    - { name: "net.core.netdev_max_backlog", value: "16384" }
    - { name: "net.ipv4.tcp_max_syn_backlog", value: "65535" }

    # UDP buffer sizes for cloudflared
    - { name: "net.core.rmem_max",         value: "7500000" }
    - { name: "net.core.wmem_max",         value: "7500000" }

- name: Enable unattended-upgrades
  apt:
    name: unattended-upgrades
    state: present

- name: Configure unattended-upgrades
  template:
    src: 50unattended-upgrades.j2
    dest: /etc/apt/apt.conf.d/50unattended-upgrades

- name: Enable automatic updates
  copy:
    dest: /etc/apt/apt.conf.d/20auto-upgrades
    content: |
      APT::Periodic::Update-Package-Lists "1";
      APT::Periodic::Unattended-Upgrade "1";

- name: SSH hardening drop-in
  copy:
    dest: /etc/ssh/sshd_config.d/99-hardening.conf
    owner: root
    group: root
    mode: "0644"
    content: |
      # Auth: keys only
      PasswordAuthentication no
      KbdInteractiveAuthentication no
      ChallengeResponseAuthentication no
      PermitEmptyPasswords no
      PubkeyAuthentication yes

      PermitRootLogin no

      # Reduce brute force surface
      MaxAuthTries 3
      LoginGraceTime 20
      MaxSessions 5

      # trusted networks (Tailscale + WireGuard)
      Match Address 100.64.0.0/10,10.99.0.0/28
        MaxAuthTries 20

      # Safer defaults
      X11Forwarding no
      AllowAgentForwarding no
      AllowTcpForwarding no
      PermitTunnel no

      # Optional: restrict who can SSH
      # AllowUsers debian
  notify: reload ssh

- name: Validate sshd config before reload
  command: sshd -t
  changed_when: false
