- name: Ensure dir exists
  file:
    path: "{{ grafana_dir }}/config"
    state: directory
    mode: '0755'

- name: Copy grafana config
  become: true
  become_user: root
  template:
    src: "{{ playbook_dir }}/roles/logging/templates/loki-config.yml"
    dest: "{{ loki_dir }}/config/loki-config.yml"
    owner: "{{ deploy_user }}"
    mode: '0644'

- name: Deploy Grafana container
  docker_container:
    name: "grafana"
    image: "grafana/grafana:latest"
    restart_policy: unless-stopped
    state: started
    ports:
      - "{{ tailscale_ip }}:{{ grafana_port }}:3000"
    volumes:
      - "{{ grafana_dir }}/config:/etc/loki"
      - grafana_data:/var/lib/grafana
