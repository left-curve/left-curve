- name: Ensure config dir exists
  file:
    path: "{{ config_dir }}"
    state: directory
    mode: '0755'

- name: Abort if password is empty
  assert:
    that:
      - clickhouse_password is defined
      - clickhouse_password | length > 0
    fail_msg: "CLICKHOUSE_PASSWORD must be set and non-empty, aborting deployment."

- name: Copy config files
  template:
    src: "{{ item }}"
    dest: "{{ config_dir }}/{{ item }}"
    mode: '0644'
  loop:
    - config.xml
    - users.xml

- name: Copy backup script
  template:
    src: "make_clickhouse_backup.sh"
    dest: "{{ ansible_facts['env']['HOME'] }}"
    mode: '0755'

- name: Create clickhouse network
  docker_network:
    name: clickhouse

- name: Deploy clickhouse container
  docker_container:
    name: "{{ container_name }}"
    image: "clickhouse/clickhouse-server:{{ clickhouse_version }}"
    restart_policy: unless-stopped
    state: started
    recreate: true
    networks:
      - name: clickhouse
    env:
      CLICKHOUSE_SKIP_USER_SETUP: "1"
    labels:
      com.docker.compose.service: "clickhouse"
      service_name: "clickhouse"
      environment: "production"
    ports:
      - "127.0.0.1:9000:9000" # Native TCP interface
      - "{{ tailscale_ip }}:9126:9126" # Prometheus metrics
      - "{{ wireguard_ip }}:9126:9126" # Prometheus metrics
    volumes:
      - "{{ data_dir }}:/var/lib/clickhouse"
      - "{{ logs_dir }}:/var/log/clickhouse-server"
      - "{{ config_dir }}/config.xml:/etc/clickhouse-server/config.xml:ro"
      - "{{ config_dir }}/users.xml:/etc/clickhouse-server/users.xml:ro"
    ulimits:
      - "nofile:262144:262144"
    healthcheck:
      test:
        [
          "CMD",
          "clickhouse-client",
          "--user",
          "default",
          "--password",
          "{{ clickhouse_password }}",
          "--query",
          "SELECT 1"
        ]
      interval: 5s
      timeout: 5s
      retries: 10
