- name: Ensure config dir exists
  file:
    path: "{{ config_dir }}"
    state: directory
    mode: '0755'

- name: Abort if password is empty
  assert:
    that:
      - clickhouse_password is defined
      - clickhouse_password | length > 0
    fail_msg: "CLICKHOUSE_PASSWORD must be set and non-empty, aborting deployment."

- name: Copy config files
  template:
    src: "{{ item }}"
    dest: "{{ config_dir }}/{{ item }}"
    mode: '0644'
  loop:
    - config.xml
    - users.xml

- name: Copy backup script
  template:
    src: "make_clickhouse_backup.sh"
    dest: "{{ ansible_facts['env']['HOME'] }}"
    mode: '0755'

- name: Write .env for docker-compose
  copy:
    dest: "{{ deploy_dir }}/.env"
    mode: "0600"
    content: |
      CONTAINER_NAME={{ container_name }}
      CLICKHOUSE_VERSION={{ clickhouse_version }}
      CLICKHOUSE_PASSWORD={{ clickhouse_password }}
      TAILSCALE_IP={{ tailscale_ip }}
      WIREGUARD_IP={{ wireguard_ip }}
      DATA_DIR={{ data_dir }}
      LOGS_DIR={{ logs_dir }}
      CONFIG_DIR={{ config_dir }}

- name: Copy docker-compose.yml
  template:
    src: docker-compose.yml
    dest: "{{ deploy_dir }}/docker-compose.yml"
    mode: '0644'

- name: Stop existing clickhouse container (pre-compose migration)
  docker_container:
    name: "{{ container_name }}"
    state: absent
  ignore_errors: true

- name: Create clickhouse network
  docker_network:
    name: clickhouse

- name: Pre-pull image (avoid downtime while pulling)
  community.docker.docker_image:
    name: "clickhouse/clickhouse-server:{{ clickhouse_version }}"
    source: pull

- name: Start clickhouse stack
  community.docker.docker_compose_v2:
    project_src: "{{ deploy_dir }}"
    pull: always
    recreate: always
    remove_orphans: true
    wait: true
    wait_timeout: 300
