- name: Ensure config dir exists
  file:
    path: "{{ config_dir }}"
    state: directory
    mode: '0755'

- name: Abort if password is empty
  assert:
    that:
      - clickhouse_password is defined
      - clickhouse_password | length > 0
    fail_msg: "CLICKHOUSE_PASSWORD must be set and non-empty, aborting deployment."

- name: Copy config files
  template:
    src: "{{ item }}"
    dest: "{{ config_dir }}/{{ item }}"
    mode: '0644'
  loop:
    - config.xml
    - users.xml

- name: Copy backup script
  template:
    src: "make_clickhouse_backup.sh"
    dest: "{{ clickhouse_dir }}"
    mode: '0755'

- name: Copy docker-compose.yml
  template:
    src: docker-compose.yml
    dest: "{{ clickhouse_dir }}/docker-compose.yml"
    mode: '0644'

- name: Deploy clickhouse stack
  community.docker.docker_compose_v2:
    project_src: "{{ clickhouse_dir }}"
    pull: always
    recreate: always
    remove_orphans: true
    wait: true
    wait_timeout: 300
