- name: Set port facts from local variable
  set_fact:
    "{{ item }}": "{{ ports[dango_network][item] }}"
  loop:
    - db_metrics_port
    - clickhouse_metrics_port
    - dango_port
    - dango_frontend_port
    - dango_metrics_port
    - faucet_port
    - quest_port
    - cometbft_p2p_port
    - cometbft_rpc_port
    - cometbft_abci_port
    - cometbft_metrics_port

- name: Check if deployment already exists
  stat:
    path: "{{ ansible_env.HOME }}/deployments/{{ deployment_name }}/.env"
  register: env_file_exists

- name: Read .env values
  shell: |
    grep -E '^(CLICKHOUSE_DATABASE|POSTGRES_DATABASE|CLICKHOUSE_METRICS_PORT|DB_METRICS_PORT|DANGO_PORT|DANGO_METRICS_PORT|FAUCET_PORT|DANGO_FRONTEND_PORT|QUEST_PORT|COMETBFT_P2P_PORT|COMETBFT_RPC_PORT|COMETBFT_ABCI_PORT|COMETBFT_METRICS_PORT)=' {{ ansible_env.HOME }}/deployments/{{ deployment_name }}/.env | \
    awk -F= '{print tolower($1) "=" $2}'
  register: existing_port_pairs
  when: env_file_exists.stat.exists

- set_fact:
    skip_port_discovery: false
    validator_private_key_exists: false

- name: Set facts from existing .env
  set_fact:
    "{{ item.split('=')[0] }}": "{{ item.split('=')[1] }}"
    skip_port_discovery: true
  loop: "{{ existing_port_pairs.stdout_lines }}"
  when: env_file_exists.stat.exists and existing_port_pairs.stdout_lines | length > 0

- name: Check if cometbft keys already exists
  stat:
    path: "{{ ansible_env.HOME }}/deployments/{{ deployment_name }}/cometbft/config/priv_validator_key.json"
  register: validator_private_key_file_exists

- name: Set port facts from existing .env
  set_fact:
    validator_private_key_exists: true
  when: validator_private_key_file_exists.stat.exists

- name: Create deployment directories
  file:
    path: "{{ ansible_env.HOME }}/deployments/{{ deployment_name }}/{{ item }}"
    state: directory
  loop: ["dango/config", "clickhouse", "cometbft/config"]
  when: not env_file_exists.stat.exists

- name: Login to GHCR
  community.docker.docker_login:
    registry: ghcr.io
    username: "{{ ghcr_user }}"
    password: "{{ ghcr_token }}"
