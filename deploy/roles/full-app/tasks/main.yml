- name: Create deployment directory
  file:
    path: "{{ ansible_env.HOME }}/deployments/{{ deployment_name }}/configs/{{ item }}"
    state: directory
  loop: [clickhouse, dango, cometbft]

- name: Copy config files
  become: true
  become_user: root
  template:
    src: "{{ item.src }}"
    dest: "{{ ansible_env.HOME }}/deployments/{{ deployment_name }}/configs/{{ item.dest }}"
    owner: "{{ deploy_user }}"
  loop:
    - { src: "{{ dango_network}}/config/dango/app.toml", dest: "dango/app.toml" }
    - { src: "{{ dango_network}}/config/cometbft/config.toml", dest: "cometbft/config.toml" }
    - { src: "{{ dango_network}}/config/cometbft/genesis.json", dest: "cometbft/genesis.json" }
    - { src: "{{ dango_network}}/config/cometbft/node_key.json", dest: "cometbft/node_key.json" }
    - { src: "{{ dango_network}}/config/cometbft/priv_validator_key.json", dest: "cometbft/priv_validator_key.json" }
    - { src: "clickhouse/config.xml", dest: "clickhouse/config.xml" }
    - { src: "clickhouse/users.xml", dest: "clickhouse/users.xml" }

- name: Generate docker-compose.yml
  become: true
  become_user: root
  template:
    src: docker-compose.yml
    dest: "{{ ansible_env.HOME }}/deployments/{{ deployment_name }}/docker-compose.yml"
    owner: "{{ deploy_user }}"

- name: Login to GHCR
  community.docker.docker_login:
    registry: ghcr.io
    username: "{{ ghcr_user }}"
    password: "{{ ghcr_token }}"

- name: Deploy stack
  community.docker.docker_compose_v2:
    project_name: "{{ deployment_name }}"
    project_src: "{{ ansible_env.HOME }}/deployments/{{ deployment_name }}"
    pull: always
    recreate: always
