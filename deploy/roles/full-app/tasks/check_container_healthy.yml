- name: Install docker health checker
  become: true
  become_user: root
  ansible.builtin.copy:
    src: check_docker.sh
    dest: /usr/local/bin/check_docker.sh
    mode: '0755'

- name: Wait up to 10s for containers to be healthy/running
  ansible.builtin.command:
    argv:
      - /usr/local/bin/check_docker.sh
      - "{{ deployment_name }}"
  register: health
  changed_when: false
  failed_when: false
  until: health.rc == 0
  retries: 10
  delay: 1

- debug: var=health.stdout_lines

- name: Add container health summary to GitHub
  delegate_to: localhost
  connection: local
  become: false
  shell: |
    cat >> "$GITHUB_STEP_SUMMARY" <<'EOF'
    # 🐳 Container Health
    | Container | Status |
    | --------- | ------ |
    {% for line in health.stdout_lines | default([]) %}
    {% set parts = line.split(' -> ', 1) %}
    | {{ parts[0] }} | {{ parts[1] if parts|length > 1 else '' }} |
    {% endfor %}
    EOF
  when:
    - health.stdout_lines is defined
    - health.stdout_lines | length > 0
