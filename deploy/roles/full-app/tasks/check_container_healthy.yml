- name: Wait until all containers are healthy
  community.docker.docker_container_info:
    filters:
      label:
        - "com.docker.compose.project={{ deployment_name }}"
  register: cinfo
  until: >
    (
      (
        cinfo.containers |
        selectattr('State.Health','defined') |
        selectattr('State.Health.Status','!=','healthy') |
        list
      ) | length == 0
    ) and
    (
      (
        cinfo.containers |
        rejectattr('State.Health','defined') |
        selectattr('State.Status','!=','running') |
        list
      ) | length == 0
    )
  retries: 10
  delay: 1

- name: Show container health
  debug:
    msg: "{{ item.Name }} -> {{ (item.State.Health.Status | default(item.State.Status)) }}"
  loop: "{{ cinfo.containers }}"
