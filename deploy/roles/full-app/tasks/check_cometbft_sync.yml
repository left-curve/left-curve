- set_fact:
    cometbft_rpc_port: "{{ traefik[dango_network].ports.cometbft_rpc_port }}"
  when: traefik_enabled

- debug:
    msg: "Fetching http://{{ wireguard_ip }}:{{ cometbft_rpc_port }}/status"

- name: Wait for CometBFT to sync
  uri:
    url: "http://{{ wireguard_ip }}:{{ cometbft_rpc_port }}/status"
    return_content: yes
  register: cometbft_status
  until: not (cometbft_status.json.result.sync_info.catching_up | default(true))
  retries: 30
  delay: 10

- name: Check peer connections
  uri:
    url: "http://{{ wireguard_ip }}:{{ cometbft_rpc_port }}/net_info"
    return_content: yes
  register: cometbft_net_info

- name: Display sync info
  debug:
    msg: |
      Node: {{ inventory_hostname }}
      Catching up: {{ (cometbft_status.json.result.sync_info.catching_up | default(true)) }}
      Latest block height: {{ cometbft_status.json.result.sync_info.latest_block_height }}
      Latest block time: {{ cometbft_status.json.result.sync_info.latest_block_time }}
      Connected peers: {{ cometbft_net_info.json.result.n_peers }}

- name: Ensure CometBFT has full peer connections
  assert:
    that:
      - cometbft_net_info.json.result.n_peers | int == (ansible_play_hosts | length) - 1
    fail_msg: >-
      {{ inventory_hostname }} has only
      {{ cometbft_net_info.json.result.n_peers }} peers,
      expected {{ (ansible_play_hosts | length) - 1 }}.
    success_msg: >-
      {{ inventory_hostname }} connected to all {{ (ansible_play_hosts | length) - 1 }} peers.

- name: Wait until service reports is_running=true
  ansible.builtin.uri:
    url: "{{ indexer_url }}/up"
    method: GET
    return_content: yes
    status_code: 200
  register: dango_up
  retries: 6
  delay: 5
  until: (dango_up.json.is_running | default(false)) | bool

- name: Show health snapshot
  ansible.builtin.debug:
    msg: |
      is_running: {{ dango_up.json.is_running }}
      height: {{ dango_up.json.block.height }}
      indexed: {{ dango_up.json.indexed_block_height }}
      git: {{ dango_up.json.git_commit }}

- name: Assert indexing lag â‰¤ 3 blocks
  ansible.builtin.assert:
    that:
      - (dango_up.json.block.height | int) - (dango_up.json.indexed_block_height | int) <= 3
    fail_msg: >-
      Index lag too high: height={{ dango_up.json.block.height }},
      indexed={{ dango_up.json.indexed_block_height }}
