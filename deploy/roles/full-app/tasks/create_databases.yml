- name: Install psycopg2 so Ansible can talk to Postgres
  tags: setup
  become: true
  become_user: root
  apt:
    name: python3-psycopg2
    state: present
- block:
    - name: Create postgres Dango DB user
      tags: setup
      community.postgresql.postgresql_user:
        name: "{{ postgres_dango_user }}"
        password: "{{ postgres_dango_password }}"
        login_user: "{{ postgres_user }}"
        login_password: "{{ postgres_password }}"
        login_host: "{{ postgres_host }}"
        login_port: "{{ postgres_port }}"
        state: present

    - name: Create postgres Dango production database
      tags: setup
      community.postgresql.postgresql_db:
        name: "{{ postgres_database }}"
        owner: "{{ postgres_dango_user }}"
        login_user: "{{ postgres_user }}"
        login_password: "{{ postgres_password }}"
        login_host: "{{ postgres_host }}"
        login_port: "{{ postgres_port }}"
        state: present

    - name: Grant psql ALL privileges on the Dango database to the Dango user
      tags: setup
      community.postgresql.postgresql_privs:
        type: database
        privs: ALL
        roles: "{{ postgres_dango_user }}"
        login_db: "{{ postgres_database }}"
        login_user: "{{ postgres_user }}"
        login_password: "{{ postgres_password }}"
        login_host: "{{ postgres_host }}"
        login_port: "{{ postgres_port }}"
        state: present
  when: not deploy_includes_postgres

- block:
    - name: Create clickhouse database
      community.clickhouse.clickhouse_db:
        name: "{{ clickhouse_database }}"
        state: present
        login_host: "{{ clickhouse_host }}"
        login_port: "{{ clickhouse_tcp_port }}"
        login_user: "{{ clickhouse_user }}"
        login_password: "{{ clickhouse_password }}"

    - name: Create clickhouse dango user
      community.clickhouse.clickhouse_user:
        login_host: "{{ clickhouse_host }}"
        login_port: "{{ clickhouse_tcp_port }}"
        login_user: "{{ clickhouse_user }}"
        login_password: "{{ clickhouse_password }}"
        name: "{{ clickhouse_dango_user }}"
        password: "{{ clickhouse_dango_password }}"
        update_password: always

    - name: Grant clickhouse database access to user
      community.clickhouse.clickhouse_client:
        execute: "GRANT ALL ON {{ clickhouse_database }}.* TO {{ clickhouse_dango_user }}"
        login_host: "{{ clickhouse_host }}"
        login_port: "{{ clickhouse_tcp_port }}"
        login_user: "{{ clickhouse_user }}"
        login_password: "{{ clickhouse_password }}"

    - name: Configure dango user settings
      community.clickhouse.clickhouse_client:
        login_host: "{{ clickhouse_host }}"
        login_port: "{{ clickhouse_tcp_port }}"
        login_user: "{{ clickhouse_user }}"
        login_password: "{{ clickhouse_password }}"
        execute: >
          ALTER USER {{ clickhouse_dango_user }}
          SETTINGS
            max_concurrent_queries_for_user = 0,
            max_memory_usage = 32000000000,
            max_memory_usage_for_user = 48000000000,
            max_threads = 12
  when: not deploy_includes_clickhouse
