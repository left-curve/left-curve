- name: Check if liquidity setup already done (current deployment)
  stat:
    path: "{{ ansible_facts['env']['HOME'] }}/deployments/{{ current_deployment }}/bot_liquidity_setup_done"
  register: current_liquidity_setup_flag
  when: current_deployment is defined and system_wide_directories
  run_once: true
  delegate_to: "{{ dex_bot_host }}"

- name: Check if liquidity setup already done
  stat:
    path: "{{ deployment_dir }}/bot_liquidity_setup_done"
  register: liquidity_setup_flag
  run_once: true
  delegate_to: "{{ dex_bot_host }}"

- name: Setup liquidity (mint and provide)
  when:
    - not liquidity_setup_flag.stat.exists
    - not (current_liquidity_setup_flag.stat.exists | default(false))
  run_once: true
  delegate_to: "{{ dex_bot_host }}"
  block:
    - set_fact:
        mint_command: "dex liquidity mint http://dango:8080/ {{ dango.dex_bot.mint_amount }} {{ dango.dex_bot.address }} --address {{ dango.dex_bot.minter_address }} --username {{ dango.dex_bot.minter_username }} --private-key {{ dango.dex_bot.minter_private_key }}"
        provide_liquidity_command: "dex liquidity provide http://dango:8080/ {{ dango.dex_bot.liquidity_amount }} --address {{ dango.dex_bot.minter_address }} --username {{ dango.dex_bot.minter_username }} --private-key {{ dango.dex_bot.minter_private_key }}"

    - debug:
        msg: "Calling: {{ provide_liquidity_command }} && {{ mint_command }}"

    # This fails when dex-bot wasn't started
    # - name: Run both liquidity commands in sequence
    #   community.docker.docker_compose_v2_exec:
    #     project_name: "{{ deployment_name }}"
    #     project_src: "{{ deployment_dir }}"
    #     service: dex-bot
    #     command: bash -c "{{ provide_liquidity_command }} ; {{ mint_command }} ; exit 0"
    #     tty: yes
    #   register: liquidity_result
    #   retries: 3
    #   delay: 5

    - name: Run both liquidity commands and capture output
      shell: |
        docker run --rm \
          --name {{ deployment_name }}-dex-bot-liquidity \
          --network {{ deployment_name }}_default \
          --env-file {{ deployment_dir }}/.env \
          -e http_url=http://dango:8080 \
          ghcr.io/left-curve/bots/dex:{{ dex_bot_tag }} \
          bash -lc '{{ provide_liquidity_command }} && {{ mint_command }}'
      register: liquidity_result
      ignore_errors: true
      retries: 3
      delay: 5
      failed_when: false

    - name: Show liquidity command output
      debug:
        msg: |
          Status: {{ 'SUCCESS ✅' if liquidity_result.rc == 0 else 'FAILED ❌' }}
          Exit Code: {{ liquidity_result.rc }}

          === STDOUT ===
          {{ liquidity_result.stdout }}

          === STDERR ===
          {{ liquidity_result.stderr }}

    - name: Query balances
      community.docker.docker_compose_v2_exec:
        project_name: "{{ deployment_name }}"
        project_src: "{{ deployment_dir }}"
        service: dango
        command: bash -lc "dango query balances {{ item }}"
        tty: yes
      loop: [ "{{ dango.dex_bot.address }}", "{{ dango.dex_bot.dex_address }}" ]
      register: balances_raw

    - debug:
        var: balances_raw

    - name: Pretty output
      vars:
        report: |-
          {%- for r in balances_raw.results -%}
          {%- set data = (r.stdout | from_json).balances -%}
          Address: {{ r.item }}
          -------------------------------
          {%- for k, v in data.items() if (v|int) > 0 -%}
          {{ "%-24s %s"|format(k, v) }}
          {%- endfor -%}

          {%- endfor -%}
      debug:
        msg: "{{ report }}"

- name: Mark liquidity setup as done
  file:
    path: "{{ deployment_dir }}/bot_liquidity_setup_done"
    state: touch
  when:
    - liquidity_result is defined
    - liquidity_result is succeeded
  run_once: true
  delegate_to: "{{ dex_bot_host }}"
