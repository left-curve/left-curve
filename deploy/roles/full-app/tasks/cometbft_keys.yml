- set_fact:
    cometbft_user_dir: /root/.cometbft

- name: Generate CometBFT keys then fetch them
  when: cometbft_generate_keys | default(false)
  block:
    - name: Generate CometBFT keys
      command: >
        docker run --rm
        -v {{ ansible_env.HOME }}/deployments/{{ deployment_name }}/configs/cometbft:{{ cometbft_user_dir }}/config
        -v {{ ansible_env.HOME }}/deployments/{{ deployment_name }}/data/cometbft:{{ cometbft_user_dir }}/data
        ghcr.io/left-curve/left-curve/cometbft:{{ cometbft_tag }}
        sh -c "
        if [ ! -f {{ cometbft_user_dir }}/config/node_key.json ]; then
          cometbft init --home {{ cometbft_user_dir }} && echo 'Initialized'
        else
          echo 'Already initialized'
        fi"

    - name: Get CometBFT node ID
      command: >
        docker run --rm
        -v {{ ansible_env.HOME }}/deployments/{{ deployment_name }}/configs/cometbft:{{ cometbft_user_dir }}/config
        -v {{ ansible_env.HOME }}/deployments/{{ deployment_name }}/data/cometbft:{{ cometbft_user_dir }}/data
        ghcr.io/left-curve/left-curve/cometbft:{{ cometbft_tag }}
        cometbft show-node-id --home {{ cometbft_user_dir }}
      register: cometbft_node_id_result

    - name: Get validator public key
      command: >
        docker run --rm
        -v {{ ansible_env.HOME }}/deployments/{{ deployment_name }}/configs/cometbft:{{ cometbft_user_dir }}/config
        -v {{ ansible_env.HOME }}/deployments/{{ deployment_name }}/data/cometbft:{{ cometbft_user_dir }}/data
        ghcr.io/left-curve/left-curve/cometbft:{{ cometbft_tag }}
        cometbft show-validator --home {{ cometbft_user_dir }}
      register: cometbft_validator_public_key_result

    - name: Get validator private key
      command: >
        docker run --rm
        -v {{ ansible_env.HOME }}/deployments/{{ deployment_name }}/configs/cometbft:{{ cometbft_user_dir }}/config
        ghcr.io/left-curve/left-curve/cometbft:{{ cometbft_tag }}
        cat {{ cometbft_user_dir }}/config/priv_validator_key.json
      register: cometbft_priv_validator_key_result

    - name: Calculate validator address
      shell: >
        echo "{{ (cometbft_validator_public_key_result.stdout | from_json).value }}" | base64 -d | sha256sum | head -c 40 | tr '[:lower:]' '[:upper:]'
      register: validator_address_calc

    - name: Set validator facts
      set_fact:
        cometbft_validator_public_key: "{{ (cometbft_validator_public_key_result.stdout | from_json).value }}"
        cometbft_validator_address: "{{ validator_address_calc.stdout }}"
        cometbft_validator_private_key: "{{ (cometbft_priv_validator_key_result.stdout | from_json).priv_key.value }}"
        cometbft_node_id: "{{ cometbft_node_id_result.stdout }}"

    - name: Read and parse node_key.json
      command: >
        docker run --rm
        -v {{ ansible_env.HOME }}/deployments/{{ deployment_name }}/configs/cometbft:{{ cometbft_user_dir }}/config
        -v {{ ansible_env.HOME }}/deployments/{{ deployment_name }}/data/cometbft:{{ cometbft_user_dir }}/data
        ghcr.io/left-curve/left-curve/cometbft:{{ cometbft_tag | default('v0.38.17') }}
        cat  {{ cometbft_user_dir }}/config/node_key.json
      register: cometbft_node_key_result

    - name: Extract node key value
      set_fact:
        cometbft_node_key: "{{ (cometbft_node_key_result.stdout | from_json).priv_key.value }}"

    - name: Clean up generated files
      become: true
      file:
        path: "{{ ansible_env.HOME }}/deployments/{{ deployment_name }}/{{ item }}"
        state: absent
      loop:
        - "configs/cometbft/node_key.json"
        - "configs/cometbft/priv_validator_key.json"
        - "configs/cometbft/config.toml"
        - "configs/cometbft/genesis.json"
        - "data/"

    - name: Debug keys
      debug:
        var: item
      loop:
        - "Node {{ inventory_hostname }}"
        - "Node ID (p2p): {{ cometbft_node_id }}"
        - "Node Key Value: [{{ cometbft_node_key | length }} chars]"
        - "Validator Public Key: {{ cometbft_validator_public_key }}"
        - "Validator Private Key: [{{ cometbft_validator_private_key | length }} chars]"
        - "Validator Address: {{ cometbft_validator_address }}"
        - "P2P Address: {{ cometbft_node_id }}@{{ tailscale_ip }}:{{ cometbft_p2p_port }}"
