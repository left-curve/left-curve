- name: Set ports to 0
  set_fact:
    dango_port: 0
    dango_metrics_port: 0
    faucet_port: 0
    dango_frontend_port: 0
    dango_metrics_port: 0

- name: Generate .env with the 0 ports
  become: true
  become_user: root
  template:
    src: env.j2
    dest: "{{ ansible_env.HOME }}/deployments/{{ deployment_name }}/.env"
    owner: "{{ deploy_user }}"

- name: Deploy dango stack first to get binded ports
  community.docker.docker_compose_v2:
    project_name: "{{ deployment_name }}"
    project_src: "{{ ansible_env.HOME }}/deployments/{{ deployment_name }}"
    pull: always
    recreate: always
    services:
      - db
      - faucet-bot
      - clickhouse
      - dango
      - cometbft

- name: Get dango and faucet assigned ports
  shell: |
    docker port {{ deployment_name }}-dango-1 8080 | cut -d: -f2
    docker port {{ deployment_name }}-dango-1 9191 | cut -d: -f2
    docker port {{ deployment_name }}-faucet-bot-1 8082 | cut -d: -f2
  register: assigned_ports

- name: Set dango, dango_metrics and faucet port facts
  set_fact:
    dango_port: "{{ assigned_ports.stdout_lines[0] }}"
    dango_metrics_port: "{{ assigned_ports.stdout_lines[1] }}"
    faucet_port: "{{ assigned_ports.stdout_lines[2] }}"

- name: Generate .env with the right ports
  become: true
  become_user: root
  template:
    src: env.j2
    dest: "{{ ansible_env.HOME }}/deployments/{{ deployment_name }}/.env"
    owner: "{{ deploy_user }}"

- name: Deploy all
  community.docker.docker_compose_v2:
    project_name: "{{ deployment_name }}"
    project_src: "{{ ansible_env.HOME }}/deployments/{{ deployment_name }}"
    wait: true
    wait_timeout: 300

- name: Get frontend assigned ports
  shell: |
    docker port {{ deployment_name }}-dango-frontend-1 80 | cut -d: -f2
  register: assigned_ports

- name: Set frontend port facts
  set_fact:
    dango_frontend_port: "{{ assigned_ports.stdout_lines[0] }}"
