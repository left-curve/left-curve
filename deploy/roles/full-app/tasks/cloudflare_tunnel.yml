- set_fact:
    pr_tunnel_name: "pr-{{ github_pr_number }}-{{ hostname }}"

- name: List tunnels (filter by name)
  uri:
    url: "https://api.cloudflare.com/client/v4/accounts/{{ cloudflare_account_id }}/cfd_tunnel?name={{ pr_tunnel_name }}"
    method: GET
    headers: { Authorization: "Bearer {{ cloudflare_api_token }}" }
  register: list_resp

- name: Create tunnel if missing
  uri:
    url: "https://api.cloudflare.com/client/v4/accounts/{{ cloudflare_account_id }}/cfd_tunnel"
    method: POST
    headers: { Authorization: "Bearer {{ cloudflare_api_token }}", Content-Type: "application/json" }
    body_format: json
    body: { name: "{{ pr_tunnel_name }}", config_src: "cloudflare" }
  register: create_resp
  when: list_resp.json.result|length == 0

- set_fact:
    pr_tunnel_token: "{{ token_resp.json.result }}"
    pr_tunnel_id: "{{ (token_resp.json.result | b64decode | from_json).t }}"

- name: CNAME PR hostnames â†’ tunnel
  community.general.cloudflare_dns:
    zone: "{{ dango_domain }}"
    record: "{{ item }}"
    type: CNAME
    value: "{{ pr_tunnel_id }}.cfargotunnel.com"
    proxied: true
    state: present
    api_token: "{{ cloudflare_api_token }}"
  loop:
    - "api-pr-{{ github_pr_number }}"
    - "www-pr-{{ github_pr_number }}"
    - "faucet-pr-{{ github_pr_number }}"
