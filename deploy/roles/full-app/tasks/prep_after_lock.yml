---
- name: Set system wide cometbft and dango directories and overwrite s3_bucket
  set_fact:
    dango_directory: "{{ ansible_facts['env']['HOME'] }}/{{ dango_network }}/{{ timestamp }}/dango"
    cometbft_directory: "{{ ansible_facts['env']['HOME'] }}/{{ dango_network }}/{{ timestamp }}/cometbft"
  when: system_wide_directories

- name: Read current deploy
  include_role:
    name: full-app
    tasks_from: read_current_deploy.yml

- name: Run setup tasks
  include_role:
    name: full-app
    tasks_from: setup.yml

- name: Detect free ports
  include_role:
    name: full-app
    tasks_from: detect_free_ports.yml
  when: expose_ports and not skip_port_discovery

- name: Generate keys
  include_role:
    name: full-app
    tasks_from: cometbft_keys.yml

- name: Wait for all hosts in play to generate keys
  wait_for:
    timeout: 1
  until: hostvars[item].cometbft_node_id is defined
  retries: 60
  delay: 2
  loop: "{{ ansible_play_hosts }}"
  run_once: true
  delegate_to: localhost

- name: Build persistent_peers list
  set_fact:
    persistent_peers: "{{ peer_list }}"
    unconditional_peer_ids: "{{ id_list }}"
  vars:
    peer_list: |-
      {%- set peers = [] -%}
      {%- for host in ansible_play_hosts -%}
        {%- if host != inventory_hostname and hostvars[host].cometbft_node_id is defined -%}
          {%- set port = (traefik_enabled | default(false))
                        | ternary(traefik[dango_network].ports.cometbft_p2p_port,
                                  hostvars[host].cometbft_p2p_port) -%}
          {%- set peer = hostvars[host].cometbft_node_id ~ '@' ~ hostvars[host].wireguard_ip ~ ':' ~ port -%}
          {{- peers.append(peer) or '' -}}
        {%- endif -%}
      {%- endfor -%}
      {{- peers | join(',') -}}
    id_list: |-
      {%- set ids = [] -%}
      {%- for host in ansible_play_hosts -%}
        {%- if host != inventory_hostname and hostvars[host].cometbft_node_id is defined -%}
          {{- ids.append(hostvars[host].cometbft_node_id) or '' -}}
        {%- endif -%}
      {%- endfor -%}
      {{- ids | join(',') -}}
  when: cometbft_node_id is defined

- name: Debug peer configuration
  debug:
    msg: "Persistent peers for {{ inventory_hostname }}: {{ persistent_peers }}"
  when: persistent_peers is defined

