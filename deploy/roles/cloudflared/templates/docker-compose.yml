services:
  cloudflared:
    image: cloudflare/cloudflared:latest
    ulimits:
      nofile:
        soft: 200000
        hard: 200000
    container_name: cloudflared
    restart: unless-stopped
    command: tunnel --no-autoupdate --config /etc/cloudflared/config.yml --metrics 0.0.0.0:2000 run --token ${CLOUDFLARE_TUNNEL_TOKEN}
    env_file:
      - .env
    volumes:
      - ./config.yml:/etc/cloudflared/config.yml:ro
    networks:
      - cloudflare
    healthcheck:
      test: ["CMD", "cloudflared", "--config", "/etc/cloudflared/config.yml", "--metrics", "0.0.0.0:2000", "tunnel", "ready"]
      interval: 5s
      timeout: 3s
      retries: 5

networks:
  cloudflare:
    external: true
