---
- name: Create cloudflared directory
  file:
    path: "{{ cloudflared_dir }}"
    state: directory
    mode: '0755'

- name: Copy cloudflared templates
  become: true
  become_user: root
  template:
    src: "{{ item.src }}"
    dest: "{{ cloudflared_dir }}/{{ item.dest }}"
    owner: "{{ deploy_user }}"
    mode: "{{ item.mode }}"
  loop:
    - { src: "env.j2", dest: ".env", mode: "0600" }
    - { src: "config.yml", dest: "config.yml", mode: "0644" }
    - { src: "docker-compose.yml", dest: "docker-compose.yml", mode: "0644" }

- name: Create cloudflare network
  community.docker.docker_network:
    name: cloudflare

- name: Start cloudflared
  community.docker.docker_compose_v2:
    project_src: "{{ cloudflared_dir }}"
    state: present
    recreate: always
    wait: true

- name: Extract tunnel ID from token
  set_fact:
    tunnel_id: "{{ (cloudflare_tunnel_token | b64decode | from_json).t }}"
  no_log: true

- name: Ensure per-host CNAME â†’ tunnel
  community.general.cloudflare_dns:
    zone: "{{ dango_domain }}"
    record: "{{ item.1 }}-{{ item.0 }}-{{ hostname }}"
    type: CNAME
    value: "{{ tunnel_id }}.cfargotunnel.com"
    proxied: true
    state: present
    api_token: "{{ cloudflare_api_token }}"
  loop: "{{ ['devnet','testnet'] | product(['api','www','faucet']) | list }}"
