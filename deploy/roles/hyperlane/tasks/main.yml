---
# ------------------------------------------------------------------------------
# Directories
# ------------------------------------------------------------------------------

- name: Ensure hyperlane base directories exist
  file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - "{{ hyperlane_agents_dir }}"
    - "{{ hyperlane_instance_dir }}"
    - "{{ hyperlane_agents_data_dir }}"

# ------------------------------------------------------------------------------
# Input validation (fail fast before writing files)
# ------------------------------------------------------------------------------

- name: Validate required inputs
  assert:
    that:
      - (hyperlane_agents_network | default('') | string | length) > 0
      - (hyperlane_agent_type | default('') | string) in ['relayer', 'validator']
    fail_msg: >-
      Missing or invalid inputs. Required:
      - hyperlane_agents_network (e.g. testnet/mainnet)
      - hyperlane_agent_type (relayer|validator)

- name: Validate validator index is provided (validator only)
  assert:
    that:
      - (hyperlane_validator_index | default('') | string | length) > 0
    fail_msg: >-
      hyperlane_validator_index is required when hyperlane_agent_type=validator.
      Example: -e hyperlane_validator_index=1
  when: hyperlane_agent_type == 'validator'

# ------------------------------------------------------------------------------
# Environment (.env) files (validated & rendered before configs)
# ------------------------------------------------------------------------------

#    ---------------------------------------------------------------------------
#    Relayer
#    ---------------------------------------------------------------------------

- name: Validate relayer secrets exist in vault
  assert:
    that:
      - relayer is defined
      - relayer[hyperlane_agents_network] is defined
    fail_msg: >-
      Missing relayer secrets in vault. Expected:
      relayer[{{ hyperlane_agents_network }}]
  when: hyperlane_agent_type == 'relayer'

- name: Check if relayer env template exists for this network
  stat:
    path: "{{ role_path }}/templates/relayer-{{ hyperlane_agents_network }}.env.j2"
  register: relayer_env_template_stat
  when: hyperlane_agent_type == 'relayer'

- name: Validate relayer env template exists for this network
  assert:
    that:
      - relayer_env_template_stat.stat.exists
    fail_msg: >-
      Missing relayer env template: relayer-{{ hyperlane_agents_network }}.env.j2
  when: hyperlane_agent_type == 'relayer'

- name: Render relayer env file
  template:
    src: "relayer-{{ hyperlane_agents_network }}.env.j2"
    dest: "{{ hyperlane_agents_env_file }}"
    owner: "{{ deploy_user }}"
    mode: "0600"
  when: hyperlane_agent_type == 'relayer'

#    ---------------------------------------------------------------------------
#    Validator
#    ---------------------------------------------------------------------------

- name: Validate validator secrets exist in vault
  assert:
    that:
      - validator is defined
      - validator[hyperlane_agents_network] is defined
      - validator[hyperlane_agents_network][hyperlane_validator_index] is defined
    fail_msg: >-
      Missing validator secrets in vault. Expected:
      validator[{{ hyperlane_agents_network }}][{{ hyperlane_validator_index }}]
  when: hyperlane_agent_type == 'validator'

- name: Check if validator env template exists for this network
  stat:
    path: "{{ role_path }}/templates/validator-{{ hyperlane_agents_network }}.env.j2"
  register: validator_env_template_stat
  when: hyperlane_agent_type == 'validator'

- name: Validate validator env template exists for this network
  assert:
    that:
      - validator_env_template_stat.stat.exists
    fail_msg: >-
      Missing validator env template: validator-{{ hyperlane_agents_network }}.env.j2
  when: hyperlane_agent_type == 'validator'

- name: Render validator env file
  template:
    src: "validator-{{ hyperlane_agents_network }}.env.j2"
    dest: "{{ hyperlane_agents_env_file }}"
    owner: "{{ deploy_user }}"
    mode: "0600"
  when: hyperlane_agent_type == 'validator'

# ------------------------------------------------------------------------------
# Config files
# ------------------------------------------------------------------------------

- name: Copy shared hyperlane config
  copy:
    src: config.json
    dest: "{{ hyperlane_agents_shared_config }}"
    owner: "{{ deploy_user }}"
    mode: "0644"

#    ---------------------------------------------------------------------------
#    Relayer
#    ---------------------------------------------------------------------------

- name: Copy relayer base config
  copy:
    src: relayer-config.json
    dest: "{{ hyperlane_agents_relayer_config }}"
    owner: "{{ deploy_user }}"
    mode: "0644"
  when: hyperlane_agent_type == 'relayer'

- name: Check if relayer network config exists
  stat:
    path: "{{ role_path }}/files/relayer-{{ hyperlane_agents_network }}-config.json"
  register: relayer_network_config_stat
  when: hyperlane_agent_type == 'relayer'

- name: Copy relayer network config
  copy:
    src: "relayer-{{ hyperlane_agents_network }}-config.json"
    dest: "{{ hyperlane_agents_relayer_network_config }}"
    owner: "{{ deploy_user }}"
    mode: "0644"
  when:
    - hyperlane_agent_type == 'relayer'
    - relayer_network_config_stat.stat.exists

#    ---------------------------------------------------------------------------
#    Validator
#    ---------------------------------------------------------------------------

- name: Copy validator base config
  copy:
    src: validator-config.json
    dest: "{{ hyperlane_agents_validator_config }}"
    owner: "{{ deploy_user }}"
    mode: "0644"
  when: hyperlane_agent_type == 'validator'

- name: Check if validator network config exists
  stat:
    path: "{{ role_path }}/files/validator-{{ hyperlane_agents_network }}-config.json"
  register: validator_network_config_stat
  when: hyperlane_agent_type == 'validator'

- name: Copy validator network config
  copy:
    src: "validator-{{ hyperlane_agents_network }}-config.json"
    dest: "{{ hyperlane_agents_validator_network_config }}"
    owner: "{{ deploy_user }}"
    mode: "0644"
  when:
    - hyperlane_agent_type == 'validator'
    - validator_network_config_stat.stat.exists

# ------------------------------------------------------------------------------
# Docker Compose
# ------------------------------------------------------------------------------

- name: Deploy Hyperlane docker-compose for this instance
  template:
    src: "docker-compose.yml.j2"
    dest: "{{ hyperlane_instance_dir }}/docker-compose.yml"
    owner: "{{ deploy_user }}"
    mode: "0644"

- name: Launch Hyperlane stack for this instance
  community.docker.docker_compose_v2:
    project_src: "{{ hyperlane_instance_dir }}"
    pull: "{{ hyperlane_agents_pull_policy }}"
    state: present
    recreate: always
  register: hyperlane_agents_compose
