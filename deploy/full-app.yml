- name: Generate keys on all nodes and build peer list
  hosts: full-app
  remote_user: "{{ deploy_user }}"
  gather_facts: yes
  any_errors_fatal: true
  vars:
  vars_files:
    - roles/full-app/vars/main.yml
  tasks:
    - name: Generate shared timestamp
      set_fact:
        timestamp: "{{ lookup('pipe', 'date -u +%Y%m%d%H%M%S') }}"
      run_once: true

    - name: Get current commit short SHA
      set_fact:
        commit_short_sha: "{{ lookup('pipe', 'git rev-parse --short=7 HEAD') }}"
      run_once: true

    - name: Get current commit title
      set_fact:
        commit_title: "{{ lookup('pipe', 'git log -1 --pretty=%s') }}"
      run_once: true

    - name: Get current commit author
      set_fact:
        commit_author: "{{ lookup('pipe', 'git log -1 --pretty=%an') }}"
      run_once: true

    - name: Set timestamp and deployment name on all hosts
      set_fact:
        deployment_name: "{{ hostvars[ansible_play_hosts[0]]['timestamp'] }}"
        timestamp: "{{ hostvars[ansible_play_hosts[0]]['timestamp'] }}"
        s3_bucket: "dango-{{ dango_network }}-{{ timestamp }}"

    - name: Fetch PR title from GitHub API (once)
      when:
        - github_pr_number is defined
      uri:
        url: "https://api.github.com/repos/{{ github_repo }}/pulls/{{ github_pr_number }}"
        method: GET
        body_format: json
        headers:
          Accept: application/vnd.github+json
          X-GitHub-Api-Version: "2022-11-28"
        return_content: true
      register: pr_api_response
      failed_when: false
      ignore_errors: true
      run_once: true
      delegate_to: localhost
      become: false

    - name: Set PR title fact from GitHub response
      when:
        - pr_api_response is defined
        - pr_api_response.json is defined
        - (pr_api_response.json.title | default('') | length) > 0
      set_fact:
        pr_title: "{{ pr_api_response.json.title }}"
      run_once: true
      delegate_to: localhost

    - name: Log deployment start
      community.general.syslogger:
        msg: "[{{ deployment_name }}] Starting deployment"
        facility: local0
        priority: info
        ident: dango

    - name: Notify Discord of deployment start
      when:
        - logs_discord_webhook is defined
      uri:
        url: "{{ logs_discord_webhook }}"
        method: POST
        status_code: 204
        body_format: json
        headers:
          Content-Type: application/json
        body:
          username: "{{ discord_username | default('Deploy Bot') }}"
          avatar_url: "{{ discord_avatar_url }}"
          embeds:
            - title: "Deployment Started"
              # description: "{{ 'üöÄ Starting deployment ' ~ deployment_name ~ ' (network=' ~ dango_network ~ ')' }}"
              color: 3447003
              fields:
                - name: "Commit title"
                  value: "{{ commit_title | default('-', true) }}"
                  inline: false
                - name: "Triggered by"
                  value: "{{ (lookup('env','USER') | default(lookup('env','LOGNAME'))) ~ '@' ~ lookup('pipe','hostname') }}"
                  inline: true
                - name: "Deployment"
                  value: "{{ deployment_name }}"
                  inline: true
                - name: "Network"
                  value: "{{ dango_network }}"
                  inline: true
                - name: "Commit"
                  value: "[{{ commit_short_sha }}](https://github.com/{{ github_repo }}/commit/{{ commit_short_sha }})"
                  inline: true
                - name: "Author"
                  value: "{{ commit_author | default('-', true) }}"
                  inline: true
              timestamp: "{{ lookup('pipe','date -u +%Y-%m-%dT%H:%M:%SZ') }}"
      delegate_to: localhost
      run_once: true
      become: false
      ignore_errors: true

    - block:
        - name: Verify SSH connectivity to target host
          wait_for_connection:
            timeout: 15
      rescue:
        - name: Mark deployment as failed (connectivity)
          set_fact:
            deploy_failed: true
        - name: Notify Discord of deployment failure (unreachable)
          when:
            - logs_discord_webhook is defined
          uri:
            url: "{{ logs_discord_webhook }}"
            method: POST
            status_code: 204
            body_format: json
            headers:
              Content-Type: application/json
            body:
              username: "{{ discord_username | default('Deploy Bot') }}"
              avatar_url: "{{ discord_avatar_url }}"
              embeds:
                - title: "‚ùå Deployment Failed ‚ùå"
                  # description: "{{ '‚ùå Deployment FAILED (unreachable host) for ' ~ deployment_name ~ ' (network=' ~ dango_network ~ ')' }}"
                  color: 15158332
                  fields:
                    - name: "Commit title"
                      value: "{{ commit_title | default('-', true) }}"
                      inline: false
                    - name: "Triggered by"
                      value: "{{ (lookup('env','USER') | default(lookup('env','LOGNAME'))) ~ '@' ~ lookup('pipe','hostname') }}"
                      inline: true
                    - name: "Host"
                      value: "{{ inventory_hostname }}"
                      inline: true
                    - name: "Deployment"
                      value: "{{ deployment_name }}"
                      inline: true
                    - name: "Network"
                      value: "{{ dango_network }}"
                      inline: true
                    - name: "Commit"
                      value: "[{{ commit_short_sha }}](https://github.com/{{ github_repo }}/commit/{{ commit_short_sha }})"
                      inline: true
                    - name: "Author"
                      value: "{{ commit_author | default('-', true) }}"
                      inline: true
                  timestamp: "{{ lookup('pipe','date -u +%Y-%m-%dT%H:%M:%SZ') }}"
          delegate_to: localhost
          run_once: true
          become: false
          ignore_errors: true

        - name: Fail unreachable early
          fail:
            msg: "Unreachable host(s) detected before deploy."

    - name: Check for existing deployment lock
      stat:
        path: "{{ deploy_lock_file }}"
      register: deploy_lock_stat

    - name: Calculate if deployment lock is recent
      set_fact:
        deploy_lock_recent: "{{ deploy_lock_stat.stat.exists and ((ansible_facts['date_time']['epoch'] | int) - (deploy_lock_stat.stat.mtime | int) < (deploy_lock_threshold_seconds | int)) }}"

    - name: Notify Discord of deployment stop due to active lock
      when:
        - deploy_lock_recent | bool
        - logs_discord_webhook is defined
      uri:
        url: "{{ logs_discord_webhook }}"
        method: POST
        status_code: 204
        body_format: json
        headers:
          Content-Type: application/json
        body:
          username: "{{ discord_username | default('Deploy Bot') }}"
          avatar_url: "{{ discord_avatar_url }}"
          embeds:
            - title: "‚õî Deployment Stopped: Active Lock"
              color: 15158332
              description: "An active deployment lock exists at {{ deploy_lock_file }}. You can manually delete the lock or retry later."
              fields:
                - name: "Triggered by"
                  value: "{{ (lookup('env','USER') | default(lookup('env','LOGNAME'))) ~ '@' ~ lookup('pipe','hostname') }}"
                  inline: true
                - name: "Deployment"
                  value: "{{ deployment_name }}"
                  inline: true
                - name: "Network"
                  value: "{{ dango_network }}"
                  inline: true
                - name: "Commit"
                  value: "[{{ commit_short_sha }}](https://github.com/{{ github_repo }}/commit/{{ commit_short_sha }})"
                  inline: true
                - name: "Lock path"
                  value: "{{ deploy_lock_file }}"
                  inline: false
              timestamp: "{{ lookup('pipe','date -u +%Y-%m-%dT%H:%M:%SZ') }}"
      delegate_to: localhost
      run_once: true
      become: false
      ignore_errors: true

    - name: Abort due to active deployment lock
      when: deploy_lock_recent | bool
      fail:
        msg: "Active deployment lock found at {{ deploy_lock_file }}. Remove manually to override."

    - name: Ensure deployments directories exist
      file:
        path: "{{ ansible_facts['env']['HOME'] }}/deployments/"
        state: directory
        mode: '0755'

    - name: Create or refresh deployment lock
      file:
        path: "{{ deploy_lock_file }}"
        state: touch
        mode: "0644"
      register: deploy_lock_touch

    - name: Mark lock as acquired
      set_fact:
        deployment_lock_set: true

    - block:
        - name: Run preparation tasks after lock
          import_role:
            name: full-app
            tasks_from: prep_after_lock.yml
      rescue:
        - name: Mark deployment as failed
          set_fact:
            deploy_failed: true
        - name: Notify Discord of deployment failure (first phase)
          when:
            - logs_discord_webhook is defined
          uri:
            url: "{{ logs_discord_webhook }}"
            method: POST
            status_code: 204
            body_format: json
            headers:
              Content-Type: application/json
            body:
              username: "{{ discord_username | default('Deploy Bot') }}"
              avatar_url: "{{ discord_avatar_url }}"
              embeds:
                - title: "‚ùå Deployment Failed ‚ùå"
                  color: 15158332
                  fields:
                    - name: "Commit title"
                      value: "{{ commit_title | default('-', true) }}"
                      inline: false
                    - name: "Triggered by"
                      value: "{{ (lookup('env','USER') | default(lookup('env','LOGNAME'))) ~ '@' ~ lookup('pipe','hostname') }}"
                      inline: true
                    - name: "Phase"
                      value: "Preparation"
                      inline: true
                    - name: "Network"
                      value: "{{ dango_network }}"
                      inline: true
                    - name: "Commit"
                      value: "[{{ commit_short_sha }}](https://github.com/{{ github_repo }}/commit/{{ commit_short_sha }})"
                      inline: true
                    - name: "Author"
                      value: "{{ commit_author | default('-', true) }}"
                      inline: true
                  timestamp: "{{ lookup('pipe','date -u +%Y-%m-%dT%H:%M:%SZ') }}"
          delegate_to: localhost
          run_once: true
          become: false
          ignore_errors: true
        - name: Remove deployment lock file on all hosts (first phase failure)
          when: deployment_lock_set | default(false)
          file:
            path: "{{ deploy_lock_file }}"
            state: absent
          become: true
          become_user: "{{ deploy_user }}"
          ignore_errors: true
        - name: Abort due to errors in preparation phase
          fail:
            msg: "Deployment failed during preparation phase; locks removed."

    # Stop for debugging
    # - meta: end_play

- hosts: full-app
  remote_user: "{{ deploy_user }}"
  any_errors_fatal: true
  collections:
    - community.docker
    - community.clickhouse
    - amazon.aws
  pre_tasks:
    - name: Load postgres vars
      include_vars: "roles/full-app/vars/included_postgres.yml"
      when: deploy_includes_postgres
    - name: Load clickhouse vars
      include_vars: "roles/full-app/vars/included_clickhouse.yml"
      when: deploy_includes_clickhouse
    - name: Build cosign verification image list
      set_fact:
        deploy_cosign_images:
          - service: "dango"
            image: "ghcr.io/left-curve/left-curve/dango"
            tag: "{{ dango_image_tag }}"
            identity_regexp: "{{ cosign_identity_rust_regexp }}"
          - service: "dango-frontend"
            image: "ghcr.io/left-curve/left-curve/dango-frontend"
            tag: "{{ frontend_image_tag }}"
            identity_regexp: "{{ cosign_identity_rust_regexp }}"
          - service: "cometbft"
            image: "ghcr.io/left-curve/left-curve/cometbft"
            tag: "{{ cometbft_tag }}"
            identity_regexp: "{{ cosign_identity_cometbft_regexp }}"
    - name: Set dango and cometbft hosts
      set_fact:
        dango_host: "{{ deployment_name }}-dango-1"
        cometbft_host: "{{ deployment_name }}-cometbft-1"

  tasks:
    - block:
        - name: Run full-app role
          import_role:
            name: full-app

      rescue:
        - name: Stop stack
          community.docker.docker_compose_v2:
            project_name: "{{ deployment_name }}"
            project_src: "{{ deployment_dir }}"
            state: stopped
          ignore_errors: true

        # I want to keep files if I need to dig further using `docker compose logs`
        # - name: Remove deployment directory
        #   become: true
        #   become_user: root
        #   file:
        #     path: "~{{ deploy_user }}/deployments/{{ deployment_name }}"
        #     state: absent

        - name: Log deployment failure
          community.general.syslogger:
            msg: "[{{ deployment_name }}] Deployment FAILED"
            facility: local0
            priority: err
            ident: dango

        - name: Mark deployment as failed
          set_fact:
            deploy_failed: true




        - name: Notify Discord of deployment failure
          when:
            - logs_discord_webhook is defined
          uri:
            url: "{{ logs_discord_webhook }}"
            method: POST
            status_code: 204
            body_format: json
            headers:
              Content-Type: application/json
            body:
              username: "{{ discord_username | default('Deploy Bot') }}"
              avatar_url: "{{ discord_avatar_url }}"
              embeds:
                - title: "‚ùå Deployment Failed ‚ùå"
                  # description: "{{ '‚ùå Deployment FAILED for ' ~ deployment_name ~ ' (network=' ~ dango_network ~ ')' }}"
                  color: 15158332
                  fields:
                    - name: "PR title"
                      value: "{{ pr_title | default('-', true) }}"
                      inline: false
                    - name: "Triggered by"
                      value: "{{ (lookup('env','USER') | default(lookup('env','LOGNAME'))) ~ '@' ~ lookup('pipe','hostname') }}"
                      inline: true
                    - name: "PR URL"
                      value: "{{ '[PR #' ~ github_pr_number ~ '](https://github.com/' ~ github_repo ~ '/pull/' ~ github_pr_number ~ ')' if (github_pr_number is defined) else '-' }}"
                      inline: true
                    - name: "Deployment"
                      value: "{{ deployment_name }}"
                      inline: true
                    - name: "Network"
                      value: "{{ dango_network }}"
                      inline: true
                    - name: "Commit"
                      value: "[{{ commit_short_sha }}](https://github.com/{{ github_repo }}/commit/{{ commit_short_sha }})"
                      inline: true
                  timestamp: "{{ lookup('pipe','date -u +%Y-%m-%dT%H:%M:%SZ') }}"
          delegate_to: localhost
          run_once: true
          become: false
          ignore_errors: true

        - name: Fail the task
          fail:
            msg: "Deployment failed, please look at the logs. You can also ssh to any of the servers, to {{ deployment_dir }} and run `docker compose logs`"

      always:
        - import_tasks: roles/full-app/tasks/resume_kuma.yml
          when: system_wide_directories

        - name: Log deployment finished
          syslogger:
            msg: "[{{ deployment_name }}] Finished deployment"
            facility: local0
            priority: info
            ident: dango

        - name: Remove deployment lock file on all hosts
          when: deployment_lock_set | default(false)
          file:
            path: "{{ deploy_lock_file }}"
            state: absent
          become: true
          become_user: "{{ deploy_user }}"
          ignore_errors: true

        - name: Notify Discord of deployment success for main
          when:
            - not (deploy_failed | default(false))
            - logs_discord_webhook is defined
            - github_pr_number is not defined
          uri:
            url: "{{ logs_discord_webhook }}"
            method: POST
            status_code: 204
            body_format: json
            headers:
              Content-Type: application/json
            body:
              username: "{{ discord_username | default('Deploy Bot') }}"
              avatar_url: "{{ discord_avatar_url }}"
              embeds:
                - title: "‚úÖ {{ dango_network }} Deployment Succeeded ‚úÖ"
                  # description: "{{ '‚úÖ Deployment SUCCEEDED for ' ~ deployment_name ~ ' (network=' ~ dango_network ~ ')' }}"
                  color: 3066993
                  fields:
                    - name: "Commit title"
                      value: "{{ commit_title | default('-', true) }}"
                      inline: false
                    - name: "Triggered by"
                      value: "{{ (lookup('env','USER') | default(lookup('env','LOGNAME'))) ~ '@' ~ lookup('pipe','hostname') }}"
                      inline: true
                    - name: "Deployment"
                      value: "{{ deployment_name }}"
                      inline: true
                    - name: "Network"
                      value: "{{ dango_network }}"
                      inline: true
                    - name: "Commit"
                      value: "[{{ commit_short_sha }}](https://github.com/{{ github_repo }}/commit/{{ commit_short_sha }})"
                      inline: true
                    - name: "Author"
                      value: "{{ commit_author | default('-', true) }}"
                      inline: true
                  timestamp: "{{ lookup('pipe','date -u +%Y-%m-%dT%H:%M:%SZ') }}"
          delegate_to: localhost
          run_once: true
          become: false
          ignore_errors: true

        - name: Notify Discord of deployment success for PR
          when:
            - not (deploy_failed | default(false))
            - logs_discord_webhook is defined
            - github_pr_number is defined
          uri:
            url: "{{ logs_discord_webhook }}"
            method: POST
            status_code: 204
            body_format: json
            headers:
              Content-Type: application/json
            body:
              username: "{{ discord_username | default('Deploy Bot') }}"
              avatar_url: "{{ discord_avatar_url }}"
              embeds:
                - title: "‚úÖ PR Deployment Succeeded ‚úÖ"
                  color: 3066993
                  fields:
                    - name: "PR title"
                      value: "{{ pr_title | default('-', true) }}"
                      inline: false
                    - name: "Commit title"
                      value: "{{ commit_title | default('-', true) }}"
                      inline: false
                    - name: "Triggered by"
                      value: "{{ (lookup('env','USER') | default(lookup('env','LOGNAME'))) ~ '@' ~ lookup('pipe','hostname') }}"
                      inline: true
                    - name: "PR URL"
                      value: "{{ '[PR #' ~ github_pr_number ~ '](https://github.com/' ~ github_repo ~ '/pull/' ~ github_pr_number ~ ')' }}"
                      inline: true
                    - name: "Deployment"
                      value: "{{ deployment_name }}"
                      inline: true
                    - name: "Network"
                      value: "{{ dango_network }}"
                      inline: true
                    - name: "Commit"
                      value: "[{{ commit_short_sha }}](https://github.com/{{ github_repo }}/commit/{{ commit_short_sha }})"
                      inline: true
                    - name: "Author"
                      value: "{{ commit_author | default('-', true) }}"
                      inline: true
                  timestamp: "{{ lookup('pipe','date -u +%Y-%m-%dT%H:%M:%SZ') }}"
          delegate_to: localhost
          run_once: true
          become: false
          ignore_errors: true

- hosts: monitoring
  remote_user: "{{ deploy_user }}"
  tags: monitoring
  vars_files:
    - roles/full-app/vars/main.yml
  tasks:
    - block:
        - name: Load prometheus vars
          include_vars: roles/prometheus/defaults/main.yml
        - name: Create Dango prometheus targets
          copy:
            content: |
              - targets: ['{{ hostvars[item].wireguard_ip }}:{{ hostvars[item].dango_metrics_port }}']
                labels:
                  deployment: '{{ deployment_name }}'
                  service: 'dango'
                  environment: 'preview'
                  dango_network: '{{ dango_network }}'
                  hostname: '{{ hostvars[item].hostname }}'
            dest: "{{ prometheus_dir }}/targets/{{ deployment_name }}-{{ hostvars[item].hostname }}-dango.yml"
            owner: "{{ deploy_user }}"
            group: "{{ deploy_user }}"
          loop: "{{ ansible_play_hosts }}"
        - name: Create Cometbft prometheus targets
          copy:
            content: |
              - targets: ['{{ hostvars[item].wireguard_ip }}:{{ hostvars[item].cometbft_metrics_port }}']
                labels:
                  deployment: '{{ deployment_name }}'
                  service: 'cometbft'
                  environment: 'preview'
                  dango_network: '{{ dango_network }}'
                  hostname: '{{ hostvars[item].hostname }}'
            dest: "{{ prometheus_dir }}/targets/{{ deployment_name }}-{{ hostvars[item].hostname }}-cometbft.yml"
            owner: "{{ deploy_user }}"
            group: "{{ deploy_user }}"
          loop: "{{ ansible_play_hosts }}"
        - name: Create Postgres prometheus targets
          when: deploy_includes_postgres
          copy:
            content: |
              - targets: ['{{ hostvars[item].wireguard_ip }}:{{ hostvars[item].db_metrics_port }}']
                labels:
                  deployment: '{{ deployment_name }}'
                  service: 'postgres'
                  environment: 'preview'
                  dango_network: '{{ dango_network }}'
                  hostname: '{{ hostvars[item].hostname }}'
            dest: "{{ prometheus_dir }}/targets/{{ deployment_name }}-{{ hostvars[item].hostname }}-postgres.yml"
            owner: "{{ deploy_user }}"
            group: "{{ deploy_user }}"
          loop: "{{ ansible_play_hosts }}"
        - name: Create Clickhouse prometheus targets
          when: deploy_includes_clickhouse
          copy:
            content: |
              - targets: ['{{ hostvars[item].wireguard_ip }}:{{ hostvars[item].clickhouse_metrics_port }}']
                labels:
                  deployment: '{{ deployment_name }}'
                  service: 'clickhouse'
                  environment: 'preview'
                  dango_network: '{{ dango_network }}'
                  hostname: '{{ hostvars[item].hostname }}'
            dest: "{{ prometheus_dir }}/targets/{{ deployment_name }}-{{ hostvars[item].hostname }}-clickhouse.yml"
            owner: "{{ deploy_user }}"
            group: "{{ deploy_user }}"
          loop: "{{ ansible_play_hosts }}"
      when:
        - hostvars[ansible_play_hosts[0]]['expose_ports'] == true
