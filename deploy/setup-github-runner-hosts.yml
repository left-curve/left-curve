- name: Prepare host for GitHub runners
  hosts: github_runners
  become: yes
  roles:
    - rust
  tasks:
    - name: Install required packages
      apt:
        name: [
            curl,
            tar,
            pipx,
            python3,
            python3-pip,
            python3-clickhouse-driver,
            libglib2.0-0
            libnss3
            libnspr4
            libdbus-1-3
            libatk1.0-0
            libatk-bridge2.0-0
            libcups2
            libdrm2
            libatspi2.0-0
            libx11-6
            libx11-xcb1
            libxcb1
            libxcomposite1
            libxdamage1
            libxext6
            libxfixes3
            libxi6
            libxrandr2
            libxtst6
            libgtk-3-0
            libgbm1
            libasound2
            libxshmfence1
            libexpat1
            libxkbcommon0,
          ]
        update_cache: yes

    - name: Ensure '{{ runner_user }}' owns its home directory
      file:
        path: "/home/{{ runner_user }}"
        owner: "{{ runner_user }}"
        group: "{{ runner_user }}"
        recurse: yes

    - name: Adding runner user to group docker
      become: true
      user:
        name: "{{ runner_user }}"
        append: true
        groups:
          - docker

    - name: Install just CLI
      ansible.builtin.shell: |
        curl -sL https://just.systems/install.sh | bash -s -- --to /usr/local/bin
      args:
        creates: /usr/local/bin/just
