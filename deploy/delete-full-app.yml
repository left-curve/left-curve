- hosts: full-app
  become: true
  become_user: "{{ deploy_user }}"
  collections:
    - community.docker
  tasks:
    - name: Check if deployment directory exists
      stat:
        path: "{{ ansible_env.HOME }}/deployments/{{ deployment_name }}"
      register: deployment_dir

    - name: Cleanup deployment
      block:
        - name: Stop and remove stack
          community.docker.docker_compose_v2:
            project_name: "{{ deployment_name }}"
            project_src: "{{ ansible_env.HOME }}/deployments/{{ deployment_name }}"
            state: absent
            remove_orphans: yes
            remove_volumes: yes
          ignore_errors: true

        # TODO: should look at `.env` and delete the unique clickhouse and
        # postgres database if any

        - name: Remove deployment directory
          become: true
          become_user: root
          file:
            path: "~{{ deploy_user }}/deployments/{{ deployment_name }}"
            state: absent

        - name: Prune unused Docker resources
          community.docker.docker_prune:
            containers: yes
            images: yes
            networks: yes
            volumes: yes
            builder_cache: yes
      when: deployment_dir.stat.exists

- hosts: monitoring
  become: true
  become_user: "{{ deploy_user }}"
  tags: monitoring
  vars:
      deployment_name: "{{ hostvars[groups['full-app'][0]]['deployment_name'] }}"
  tasks:
    - name: Load prometheus vars
      include_vars: roles/prometheus/defaults/main.yml
    - name: Remove deployment targets
      become: true
      become_user: root
      shell: rm -f {{ prometheus_dir }}/targets/{{ deployment_name }}-*
      ignore_errors: true
