name: Build & Push Docker Images to GHCR

env:
  COMETBFT_GIT_TAG: v0.38.17

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-cometbft:
    permissions:
      packages: write
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Check if Docker image already exists
        id: check-image
        run: |
          if docker manifest inspect ghcr.io/${{ github.repository }}/cometbft:${{ env.COMETBFT_GIT_TAG }} > /dev/null 2>&1; then
            echo "Image with tag ${{ env.COMETBFT_GIT_TAG }} already exists, skipping build."
            echo "skip_build=true" >> $GITHUB_OUTPUT
          else
            echo "Image does not exist, proceeding with build."
            echo "skip_build=false" >> $GITHUB_OUTPUT
          fi
      - name: Build and push Docker image
        if: steps.check-image.outputs.skip_build == 'false'
        uses: docker/build-push-action@v5
        with:
          context: ./docker/cometbft
          build-args: |
            COMETBFT_GIT_TAG=${{ env.COMETBFT_GIT_TAG }}
          platforms: linux/amd64,linux/arm64
          tags: |
            ghcr.io/${{ github.repository }}/cometbft:${{ env.COMETBFT_GIT_TAG }}
          push: true

  build-dango:
    permissions:
      packages: write
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      # - name: Log run ID
      #   run: echo "RUN_ID=${{ github.run_id }} | ATTEMPT=${{ github.run_attempt }}"
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      # - name: build arm64
      #   uses: docker/build-push-action@v5
      #   env:
      #     BUILDKIT_PROGRESS: plain
      #   with:
      #     context: ./docker/dango
      #     build-args: |
      #       GIT_COMMIT=${{ github.sha }}
      #     platforms: linux/arm64
      #     tags: |
      #       ghcr.io/${{ github.repository }}/dango:${{ github.sha }}-arm64
      #     push: true
      #     no-cache: true
      - name: build amd64
        uses: docker/build-push-action@v5
        env:
          BUILDKIT_PROGRESS: plain
        with:
          context: ./docker/dango
          build-args: |
            GIT_COMMIT=${{ github.sha }}
          platforms: linux/amd64
          tags: |
            ghcr.io/${{ github.repository }}/dango:${{ github.sha }}
          push: true
          no-cache: true
      # - name: Create and push manifest
      #   run: |
      #     docker manifest create ghcr.io/${{ github.repository }}/dango:${{ github.sha }} \
      #       --amend ghcr.io/${{ github.repository }}/dango:${{ github.sha }}-amd64 \
      #       --amend ghcr.io/${{ github.repository }}/dango:${{ github.sha }}-arm64
      #
      #     docker manifest push ghcr.io/${{ github.repository }}/dango:${{ github.sha }}

  # build-optimizer:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: docker/setup-qemu-action@v3
  #     - uses: docker/setup-buildx-action@v3
  #     - uses: docker/login-action@v3
  #       with:
  #         registry: ghcr.io
  #         username: ${{ github.actor }}
  #         password: ${{ secrets.GITHUB_TOKEN }}
  #     - uses: docker/build-push-action@v5
  #       with:
  #         context: ./docker/optimizer
  #         build-args: |
  #           GIT_COMMIT=${{ github.sha }}
  #         platforms: linux/amd64,linux/arm64
  #         tags: |
  #           ghcr.io/${{ github.repository }}/optimizer:${{ github.sha }}
  #           ghcr.io/${{ github.repository }}/optimizer:latest
