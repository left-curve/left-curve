on:
  pull_request:
    types: [closed]

jobs:
  cleanup-deployment:
    runs-on: ubuntu-latest
    steps:
      - name: Delete PR deployment
        run: |
          # Get deployment ID
          DEPLOYMENT_ID=$(curl -s \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/deployments?environment=pr-${{ github.event.pull_request.number }}" \
            | jq -r '.[0].id')

          # Set to inactive
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/deployments/$DEPLOYMENT_ID/statuses" \
            -d '{"state":"inactive","description":"PR closed - deployment deactivated"}'

          # Cleanup actual containers
          ansible-playbook delete-full-app.yml -e deployment_name=pr-${{ github.event.pull_request.number }}
