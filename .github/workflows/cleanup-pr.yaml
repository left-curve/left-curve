name: Cleanup PR

on:
  pull_request:
    types: [closed]

jobs:
  cleanup-deployment:
    runs-on: [self-hosted]
    permissions:
      packages: write
      deployments: write
    steps:
      - name: Delete PR deployments
        run: |
          ENVIRONMENTS=("preview-dango-frontend" "preview-dango-api" "preview-dango-metrics" "preview-faucet-bot" "preview-cometbft-p2p" "preview-cometbft-rpc" "preview-cometbft-abci" "preview-cometbft-metrics")

          for env in "${ENVIRONMENTS[@]}"; do
            echo "Checking environment: ${env}"
            page=1
            while true; do
              # Fetch page with per_page=100 to minimize requests
              response=$(curl -s \
                -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                "https://api.github.com/repos/${{ github.repository }}/deployments?environment=${env}&page=${page}&per_page=100")

              # Check if page is empty
              if [ "$(echo "$response" | jq '. | length')" -eq 0 ]; then
                break
              fi

              # Extract deployment IDs for this PR
              DEPLOYMENT_IDS=$(echo "$response" | \
                jq -r --arg pr "PR ${{ github.event.pull_request.number }}" \
                  '.[] | select(.description | contains($pr)) | .id')

              # Deactivate deployments found on this page
              for id in $DEPLOYMENT_IDS; do
                if [ "$id" != "null" ] && [ -n "$id" ]; then
                  echo "Deactivating deployment ID: $id in environment: ${env}"
                  curl -X POST \
                    -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                    -H "Accept: application/vnd.github.v3+json" \
                    "https://api.github.com/repos/${{ github.repository }}/deployments/${id}/statuses" \
                    -d '{"state":"inactive","description":"PR closed - deployment deactivated"}'
                fi
              done

              ((page++))
            done
          done

      - name: Delete PR container images
        run: |
          # Get PR commits to find all related image tags
          PR_COMMITS=$(curl -s \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/commits" \
            | jq -r '.[].sha')

          # Delete pr-X-latest tag
          curl -X DELETE \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/orgs/left-curve/packages/container/left-curve%2Fdango/versions" \
            -d '{"names":["pr-${{ github.event.pull_request.number }}-latest"]}'

          curl -X DELETE \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/orgs/left-curve/packages/container/left-curve%2Fdango-frontend/versions" \
            -d '{"names":["pr-${{ github.event.pull_request.number }}-latest"]}'

          # Delete commit-specific images for this PR
          for commit in $PR_COMMITS; do
            echo "Deleting image for commit: $commit"
            curl -X DELETE \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/orgs/left-curve/packages/container/left-curve%2Fdango/versions" \
              -d "{\"names\":[\"$commit\", \"$commit-amd64\", \"$commit-arm64\"]}"
            curl -X DELETE \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/orgs/left-curve/packages/container/left-curve%2Fdango-frontend/versions" \
              -d "{\"names\":[\"$commit\", \"$commit-amd64\", \"$commit-arm64\"]}"
          done

      - name: Install Ansible
        run: |
          pipx install ansible
          pipx ensurepath
          ln -f -s ~/.local/pipx/venvs/ansible/bin/ansible-galaxy ~/.local/bin/ansible-galaxy
          ln -sf ~/.local/pipx/venvs/ansible/bin/ansible-playbook ~/.local/bin/ansible-playbook
          cd deploy
          ansible-galaxy collection install -r requirements.yml

      - name: Cleanup actual containers
        run: |
          cd deploy
          pipx ensurepath
          ansible-playbook delete-full-app.yml -e deployment_name=pr-${{ github.event.pull_request.number }}
